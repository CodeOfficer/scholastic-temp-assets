// ============================================================================
// Project:   Simple Auth - Simple Authentication for Ember.js
// Copyright: ©2013-2014 Marco Otte-Witte and contributors
//            ember.js is ©2011-2014 Tilde Inc.
// License:   Licensed under MIT license
//            See https://raw.github.com/simplabs/ember-simple-auth/master/LICENSE
// ============================================================================


!function(){"use strict";function e(e){if("string"===Ember.typeOf(e)){var t=document.createElement("a");t.href=e,t.href=t.href,e=t}var i=e.port;return Ember.isEmpty(i)&&(i="http:"===e.protocol?"80":"https:"===e.protocol?"443":""),e.protocol+"//"+e.hostname+(""!==i?":"+i:"")}Ember.SimpleAuth=Ember.Namespace.create({Authenticators:Ember.Namespace.create(),Authorizers:Ember.Namespace.create(),Stores:Ember.Namespace.create(),authenticationRoute:"login",routeAfterAuthentication:"index",routeAfterInvalidation:"index",setup:function(t,i,n){n=n||{},this.routeAfterAuthentication=n.routeAfterAuthentication||this.routeAfterAuthentication,this.routeAfterInvalidation=n.routeAfterInvalidation||this.routeAfterInvalidation,this.authenticationRoute=n.authenticationRoute||this.authenticationRoute,this._crossOriginWhitelist=Ember.A(n.crossOriginWhitelist||[]).map(function(t){return e(t)}),t.register("ember-simple-auth:authenticators:oauth2",Ember.SimpleAuth.Authenticators.OAuth2);var r=(n.store||Ember.SimpleAuth.Stores.LocalStorage).create(),s=Ember.SimpleAuth.Session.create({store:r,container:t}),o=(n.authorizer||Ember.SimpleAuth.Authorizers.OAuth2).create({session:s});t.register("ember-simple-auth:session:current",s,{instantiate:!1}),Ember.A(["model","controller","view","route"]).forEach(function(e){t.injection(e,"session","ember-simple-auth:session:current")}),Ember.$.ajaxPrefilter(function(e,t,i){Ember.SimpleAuth.shouldAuthorizeRequest(e.url)&&o.authorize(i,e)})},shouldAuthorizeRequest:function(t){this._urlOrigins=this._urlOrigins||{},this._documentOrigin=this._documentOrigin||e(window.location);var i=this._urlOrigins[t]=this._urlOrigins[t]||e(t);return this._crossOriginWhitelist.indexOf(i)>-1||i===this._documentOrigin}})}(),function(){"use strict";Ember.SimpleAuth.Session=Ember.ObjectProxy.extend({authenticatorFactory:null,store:null,isAuthenticated:!1,attemptedTransition:null,content:null,init:function(){var e=this;this.bindToStoreEvents();var t=this.store.restore(),i=t.authenticatorFactory;i?(delete t.authenticatorFactory,this.container.lookup(i).restore(t).then(function(t){e.setup(i,t)},function(){e.store.clear()})):this.store.clear()},authenticate:function(e,t){var i=this;return new Ember.RSVP.Promise(function(n,r){i.container.lookup(e).authenticate(t).then(function(t){i.setup(e,t),n()},function(e){i.clear(),r(e)})})},invalidate:function(){var e=this;return new Ember.RSVP.Promise(function(t,i){var n=e.container.lookup(e.authenticatorFactory);n.invalidate(e.content).then(function(){n.off("ember-simple-auth:session-updated"),e.clear(),t()},function(e){i(e)})})},setup:function(e,t){this.setProperties({isAuthenticated:!0,authenticatorFactory:e,content:t}),this.bindToAuthenticatorEvents();var i=Ember.$.extend({authenticatorFactory:e},this.content);this.store.clear(),this.store.persist(i)},clear:function(){this.setProperties({isAuthenticated:!1,authenticatorFactory:null,content:null}),this.store.clear()},bindToAuthenticatorEvents:function(){var e=this,t=this.container.lookup(this.authenticatorFactory);t.off("ember-simple-auth:session-updated"),t.on("ember-simple-auth:session-updated",function(t){e.setup(e.authenticatorFactory,t)})},bindToStoreEvents:function(){var e=this;this.store.on("ember-simple-auth:session-updated",function(t){var i=t.authenticatorFactory;i?(delete t.authenticatorFactory,e.container.lookup(i).restore(t).then(function(t){e.setup(i,t)},function(){e.clear()})):e.clear()})}})}(),function(){"use strict";Ember.SimpleAuth.Authorizers.Base=Ember.Object.extend({session:null,authorize:function(){}})}(),function(){"use strict";Ember.SimpleAuth.Authorizers.OAuth2=Ember.SimpleAuth.Authorizers.Base.extend({authorize:function(e){Ember.isEmpty(this.get("session.access_token"))||e.setRequestHeader("Authorization","Bearer "+this.get("session.access_token"))}})}(),function(){"use strict";Ember.SimpleAuth.Authenticators.Base=Ember.Object.extend(Ember.Evented,{restore:function(){return new Ember.RSVP.Promise(function(e,t){t()})},authenticate:function(){return new Ember.RSVP.Promise(function(e,t){t()})},invalidate:function(){return new Ember.RSVP.Promise(function(e){e()})}})}(),function(){"use strict";Ember.SimpleAuth.Authenticators.OAuth2=Ember.SimpleAuth.Authenticators.Base.extend({serverTokenEndpoint:"/token",refreshAccessTokens:!0,_refreshTokenTimeout:null,restore:function(e){var t=this;return new Ember.RSVP.Promise(function(i,n){Ember.isEmpty(e.access_token)?n():(t.scheduleAccessTokenRefresh(e.expires_in,e.expires_at,e.refresh_token),i(e))})},authenticate:function(e){var t=this;return new Ember.RSVP.Promise(function(i,n){var r={grant_type:"password",username:e.identification,password:e.password};t.makeRequest(r).then(function(e){Ember.run(function(){var n=t.absolutizeExpirationTime(e.expires_in);t.scheduleAccessTokenRefresh(e.expires_in,n,e.refresh_token),i(Ember.$.extend(e,{expires_at:n}))})},function(e){Ember.run(function(){n(e.responseText)})})})},invalidate:function(){return Ember.run.cancel(this._refreshTokenTimeout),delete this._refreshTokenTimeout,new Ember.RSVP.Promise(function(e){e()})},makeRequest:function(e){return Ember.$.ajax({url:this.serverTokenEndpoint,type:"POST",data:e,dataType:"json",contentType:"application/x-www-form-urlencoded"})},scheduleAccessTokenRefresh:function(e,t,i){if(this.refreshAccessTokens){Ember.run.cancel(this._refreshTokenTimeout),delete this._refreshTokenTimeout;var n=new Date;if(Ember.isEmpty(t)&&!Ember.isEmpty(e)&&(t=new Date(n.getTime()+1e3*(e-5)).getTime()),!Ember.isEmpty(i)&&!Ember.isEmpty(t)&&t>n){var r=t-n.getTime();this._refreshTokenTimeout=Ember.run.later(this,this.refreshAccessToken,e,i,r)}}},refreshAccessToken:function(e,t){var i=this,n={grant_type:"refresh_token",refresh_token:t};this.makeRequest(n).then(function(n){Ember.run(function(){e=n.expires_in||e,t=n.refresh_token||t;var r=i.absolutizeExpirationTime(e);i.scheduleAccessTokenRefresh(e,null,t),i.trigger("ember-simple-auth:session-updated",Ember.$.extend(n,{expires_in:e,expires_at:r,refresh_token:t}))})},function(e,t,i){Ember.Logger.warn("Access token could not be refreshed - server responded with "+i+".")})},absolutizeExpirationTime:function(e){return Ember.isEmpty(e)?void 0:new Date((new Date).getTime()+1e3*(e-5)).getTime()}})}(),function(){"use strict";Ember.SimpleAuth.Stores.Base=Ember.Object.extend(Ember.Evented,{persist:function(){},restore:function(){return{}},clear:function(){}})}(),function(){"use strict";Ember.SimpleAuth.Stores.Cookie=Ember.SimpleAuth.Stores.Base.extend({cookieNamePrefix:"ember_simple_auth:",_secureCookies:"https:"===window.location.protocol,_syncPropertiesTimeout:null,init:function(){this.syncProperties()},persist:function(e){for(var t in e)this.write(t,e[t],null);this._lastProperties=JSON.stringify(this.restore())},restore:function(){var e=this,t={};return this.knownCookies().forEach(function(i){t[i]=e.read(i)}),t},clear:function(){var e=this;this.knownCookies().forEach(function(t){e.write(t,null,new Date(0).toGMTString())}),this._lastProperties=null},read:function(e){var t=document.cookie.match(new RegExp(this.cookieNamePrefix+e+"=([^;]+)"))||[];return decodeURIComponent(t[1]||"")},write:function(e,t,i){var n=Ember.isEmpty(i)?"":"; expires="+i,r=this._secureCookies?";secure":"";document.cookie=this.cookieNamePrefix+e+"="+encodeURIComponent(t)+n+r},knownCookies:function(){var e=this;return Ember.A(document.cookie.split(/[=;\s]+/)).filter(function(t){return new RegExp("^"+e.cookieNamePrefix).test(t)}).map(function(t){return t.replace(e.cookieNamePrefix,"")})},syncProperties:function(){var e=this.restore(),t=JSON.stringify(e);t!==this._lastProperties&&(this._lastProperties=t,this.trigger("ember-simple-auth:session-updated",e)),Ember.testing||(Ember.run.cancel(this._syncPropertiesTimeout),this._syncPropertiesTimeout=Ember.run.later(this,this.syncProperties,500))}})}(),function(){"use strict";Ember.SimpleAuth.Stores.Ephemeral=Ember.SimpleAuth.Stores.Base.extend({init:function(){this.clear()},persist:function(e){this._data=Ember.$.extend(e,this._data)},restore:function(){return Ember.$.extend({},this._data)},clear:function(){delete this._data,this._data={}}})}(),function(){"use strict";Ember.SimpleAuth.Stores.LocalStorage=Ember.SimpleAuth.Stores.Base.extend({keyPrefix:"ember_simple_auth:",_triggerChangeEventTimeout:null,init:function(){this.bindToStorageEvents()},persist:function(e){for(var t in e){var i=this.buildStorageKey(t);localStorage.setItem(i,e[t])}this._lastProperties=JSON.stringify(this.restore())},restore:function(){var e=this,t={};return this.knownKeys().forEach(function(i){var n=i.replace(e.keyPrefix,"");t[n]=localStorage.getItem(i)}),t},clear:function(){this.knownKeys().forEach(function(e){localStorage.removeItem(e)}),this._lastProperties=null},buildStorageKey:function(e){return this.keyPrefix+e},knownKeys:function(){for(var e=Ember.A([]),t=0,i=localStorage.length;i>t;t++){var n=localStorage.key(t);0===n.indexOf(this.keyPrefix)&&e.push(n)}return e},bindToStorageEvents:function(){var e=this;Ember.$(window).bind("storage",function(){var t=e.restore(),i=JSON.stringify(t);i!==e._lastProperties&&(e._lastProperties=i,Ember.run.cancel(e._triggerChangeEventTimeout),e._triggerChangeEventTimeout=Ember.run.next(e,function(){this.trigger("ember-simple-auth:session-updated",t)}))})}})}(),function(){"use strict";Ember.SimpleAuth.AuthenticatedRouteMixin=Ember.Mixin.create({beforeModel:function(e){this.get("session.isAuthenticated")||(e.abort(),this.triggerSessionAuthentication(e))},triggerSessionAuthentication:function(e){this.set("session.attemptedTransition",e),e.send("authenticateSession")}})}(),function(){"use strict";Ember.SimpleAuth.AuthenticationControllerMixin=Ember.Mixin.create({authenticator:null,actions:{authenticate:function(e){var t=this;this.get("session").authenticate(this.get("authenticator"),e).then(function(){t.send("sessionAuthenticationSucceeded")},function(e){t.send("sessionAuthenticationFailed",e)})}}})}(),function(){"use strict";Ember.SimpleAuth.LoginControllerMixin=Ember.Mixin.create(Ember.SimpleAuth.AuthenticationControllerMixin,{authenticator:"ember-simple-auth:authenticators:oauth2",actions:{authenticate:function(){var e=this.getProperties("identification","password");Ember.isEmpty(e.identification)||Ember.isEmpty(e.password)||(this.set("password",null),this._super(e))}}})}(),function(){"use strict";Ember.SimpleAuth.ApplicationRouteMixin=Ember.Mixin.create({actions:{authenticateSession:function(){this.transitionTo(Ember.SimpleAuth.authenticationRoute)},sessionAuthenticationSucceeded:function(){var e=this.get("session.attemptedTransition");e?(e.retry(),this.set("session.attemptedTransition",null)):this.transitionTo(Ember.SimpleAuth.routeAfterAuthentication)},sessionAuthenticationFailed:function(){},invalidateSession:function(){var e=this;this.get("session").invalidate().then(function(){e.send("sessionInvalidationSucceeded")},function(t){e.send("sessionInvalidationFailed",t)})},sessionInvalidationSucceeded:function(){this.transitionTo(Ember.SimpleAuth.routeAfterInvalidation)},sessionInvalidationFailed:function(){},authorizationFailed:function(){var e=this;this.get("session").invalidate().then(function(){e.transitionTo(Ember.SimpleAuth.routeAfterInvalidation)})},error:function(e){return 401===e.status&&this.send("authorizationFailed"),!0}}})}();